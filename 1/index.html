<!DOCTYPE html>
<html>
  <head>
    <title>駄日記　第一回　このブログの作成</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
  </head>
  <body>
    <section id="header">
      <div id="menu">
          <div>
            <a href="/メニュー"><h1 class="logo">駄日記</h1></a>
            <ul id="navigation">
              <li>&nbsp;</li>
              <li>&nbsp;</li>
            </ul>
          </div>
          <div>
          </div>
      </div>
    </section>
    <section id="content">
      <div class="padding">
          <h1 id="postid">第一回</h1>
          <h1 id="posttitle">このブログの作成</h1>
          <p>ようこそ、新ブログ「駄日記」へ！</p>
<p>最近色んな方法で日本語を磨きたいと思って、この度日本語ブログを作ってみました。そして、せっかく日本語のブログを作るなら、<a href="https://ja.wikipedia.org/wiki/%E6%97%A5%E6%9C%AC%E8%AA%9E%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0%E8%A8%80%E8%AA%9E">日本語プログラミング言語</a>で作れば良いでしょう。</p>
<p>結果はこれです。このページは<a href="https://ja.wikipedia.org/wiki/%E6%96%87%E8%8A%B8%E7%9A%84%E3%83%97%E3%83%AD%E3%82%B0%E3%83%A9%E3%83%9F%E3%83%B3%E3%82%B0">文芸的プログラム</a>になっています。つまり、<em>このページ</em>を実行すれば、サイトが出来上がります。</p>
<p>さて、サイトの実装をみましょう。</p>
<h2>プログラミング言語「なでしこ」</h2>
<p>今回使用している言語は<a href="https://nadesi.com">なでしこ</a>という日本語プログラミング言語です。詳細は<a href="https://nadesi.com">なでしこのサイト</a>に説明されていますが、簡単な例を出してみれば、こんな感じになります。</p>
<pre><code class="language-nako3">自分は「ダニー」。
相手は「皆様」。
相手に「、こんにちは！｛自分｝です。」を追加して表示。
</code></pre>
<p>出力は、<code>皆様、こんにちは！ダニーです。</code>となります。</p>
<p>シンプルで分かりやすいプログラミング言語ですね！しかも「て形」表現があり、助詞も使い、「日本語らしさ」のあるなかなか面白いプログラミング言語だと思います！</p>
<p>世界中のほとんどのプログラミング言語は英語の元で作られているので、「プログラミング＝英語」と当たり前のように思ってしまうことが多いのですが、こういう風に違う言語の元で作られるプログラミング言語があると、英語でまったく考えられない表現も出てきますね。あまりメジャーにならないかもしれないが、こんな感じの言語を作っている方がいるのがとても嬉しいです。</p>
<p>では、なでしこ言語を使ってサイトを作ってみましょう。</p>
<h2>取込みと初期化</h2>
<p>まず、これから使う道具を下準備しましょう。</p>
<p>なでしこはJavaScriptベースで出来ているので、node.jsのパッケージは全部使えます。このサイトは下記のパッケージを使用しています。</p>
<ul>
<li><a href="https://www.npmjs.com/package/mustache">mustache</a>、HTMLテンプレートシステム</li>
<li><a href="https://www.npmjs.com/package/markdown-it">markdown-it</a>、マークダウンからHTML変換</li>
<li><a href="https://www.npmjs.com/package/kansuji">kansuji</a>、アラビア数字から漢数字への変換</li>
<li><a href="https://www.npmjs.com/package/kanjidate">kanjidate</a>、西暦から和暦への変換</li>
</ul>
<p>このパッケージをなでしこからアクセスするため、<a href="https://github.com/dpwright/danikki/blob/source/%E3%83%A6%E3%83%BC%E3%83%86%E3%82%A3%E3%83%AA%E3%83%86%E3%82%A3%E3%83%BC.js">ユーティリティー.js</a>を取り込む必要があります。</p>
<pre><code class="language-nako3">!「./ユーティリティー」を取り込む。
</code></pre>
<p>投稿の原書は<a href="https://ja.wikipedia.org/wiki/Markdown">マークダウン</a>で書いています。それをHTMLに変換して、最後はテンプレートを使って、投稿、固定ページ、タグ一覧などの形にします。ここではそのテンプレートを取り込みます。</p>
<p>テンプレートは全部「テンプレート」というフォルダに入っているので、そのフォルダから取得するユーティリティー関数を作りましょう。</p>
<pre><code class="language-nako3">関数　（名前の）ページテンプレートとは
　　「テンプレート/｛名前｝」をテンプレート取込。
ここまで。
</code></pre>
<p>なでしこの関数定義はこんな漢字です。日本語は基本的に<a href="https://ja.wikipedia.org/wiki/SOV%E5%9E%8B">SOV型言語</a>ですので、関数名が最後になります。</p>
<p>関数、制御構文などは「ここまで」で終わります。ルビーで言えば「end」と同じようなものですね。個人的にただ「です」で終わりたいときもあると思います。特に関数定義と条件分岐には自然になるかなと思いますが、現在は「ここまで」しか使えません。</p>
<p>さぁ、定義した関数を使って、テンプレートを取り込みましょう。</p>
<pre><code class="language-nako3">投稿テンプレは「投稿」のページテンプレート。
固定ページテンプレは「固定ページ」のページテンプレート。
タグ一覧は「タグ一覧」のページテンプレート。
投稿一覧は「投稿一覧」のページテンプレート。
全体的投稿一覧は「全体的投稿一覧」のページテンプレート。
フィードテンプレは「フィード」のページテンプレート。
</code></pre>
<p>これでは、準備ができました。</p>
<h2>静的ファイルをコピー</h2>
<p>一番単純な処理は静的ファイルです。ファイルをそのままコピーするだけです。まず、「静的ファイル」というフォルダ以下のファイル全部（再帰的に）列挙します。毎ファイルから、「静的ファイル」以前の部分を消して、相対パスを取得します。それに「出力」というフォルダ名を足したら、コピーがでます。</p>
<pre><code class="language-nako3">「静的ファイル」を全ファイル列挙して絶対パスで反復
　　絶対パスを「静的ファイル/」で区切る。
　　相対パスはそれ＠１。
　　絶対パスを「出力/｛相対パス｝」へファイルコピー。
ここまで。
</code></pre>
<h2>情報抽出</h2>
<p>これからはマークダウンから変換しますが、そのマークダウンにメタデータを入れるつもりです。タイトル、投稿日、タグなどは最初の数行に入っています。この関数は、そのメタデータを抽出するためです。</p>
<p>まず、特別記号「#---」でファイルを二つに分けます。前部がメタデータ、後は実際のマークダウンになります。もし、「#---」というマークがなければ、メタデータなしのマークダウンファイルだということです。</p>
<pre><code class="language-nako3">関数　（ファイルから）情報抽出とは
　　出力情報は空配列。
　　区切り行は「｛改行｝#---｛改行｝」。
　　ファイルの区切り行で区切って、データに代入。
　　もしデータの要素数が１以下ならば、
　　　　ファイル内容はファイル。
　　違えば、
　　　　ファイル内容はデータ＠１。
</code></pre>
<p>二つの部分が見つかったら、ファイル内容はその二つ目（索引１）になります。一つ目（索引０）はメタデータです。メタデータのあ構成はこんな感じです。</p>
<pre><code>#   投稿名　はじめに
##  投稿日　2019-08-04
### タグ　プログラミング、なでしこ言語
</code></pre>
<p>「#」の数には特に意味がないので、無視します。</p>
<pre><code class="language-nako3">　　　　データ＠０の「#」を「」に置換。
</code></pre>
<p>全角空白と半角空白が混ざっていると処理しにくくなるので、とりあえず前部半角にします。</p>
<pre><code class="language-nako3">　　　　それの「　」を「 」に置換。
</code></pre>
<p>せれで、一行ごとに空白で分かれているキーと値のペアが取得できます。</p>
<p>タグは特別に、「、」で区切ったリストになっています。そのため、キーが「タグ」である場合、値を「、」で区切る必要があります。</p>
<pre><code class="language-nako3">　　　　それの改行で区切って、当行で反復
　　　　　　当行の空白除去して、「 」で区切る。
　　　　　　それをKVに代入。
　　　　　　もしKV＠１≠未定義ならば
　　　　　　　　もしKV＠０＝「タグ」ならば、
　　　　　　　　　　KV＠１の「、」で区切る。
　　　　　　　　　　出力情報［KV＠０］はそれ。
　　　　　　　　違えば、
　　　　　　　　　　出力情報［KV＠０］はKV＠１
　　　　　　　　ここまで。
　　　　　　ここまで。
　　　　ここまで。
　　ここまで。
</code></pre>
<p>もう一つ、ちょっと変わっている処理があります。このファイルを文芸的に書くためには、マークダウンや説明は前部なでしこのコメントに入れないとだめです。ただ、普通になでしこのコメント記号、「/&ast;」「&ast;/」、を使えばマークダウン にも表示されてしまって、読みにくくなります。それを避けるため、ここで「/&ast;」か「&ast;/」しか書いていない行があれば、マークダウン変換の前に削除します。</p>
<pre><code class="language-nako3">　　コメ開始は「｛改行｝/*｛改行｝」
　　コメ終了は「｛改行｝*/｛改行｝」
　　ファイル内容のコメ開始で区切って、改行で配列結合。
　　それのコメ終了で区切って、改行で配列結合。
　　出力情報＠「MDソース」はそれ。
</code></pre>
<p>最後は、集めた情報を関数から戻します。</p>
<pre><code class="language-nako3">　　出力情報を戻す。
ここまで。
</code></pre>
<h3>テンプレート適用</h3>
<p>メタデータとページ内容が手に入ったら、テンプレートを適用して出力できます。</p>
<p>一々「.html」の拡張子を使うのは今の時代にはかっこ悪いので、フォルダを作ってそこに「index.html」という名前に出力します。</p>
<pre><code class="language-nako3">関数　（データをテンプレートでファイル名に）出力とは
　　「出力/{ファイル名}」のフォルダ作成。
　　テンプレートを、データでテンプレートレンダー。
　　それをHTMLに代入。
　　HTMLを「出力/{ファイル名}/index.html」に保存。
　　HTMLを戻す。
ここまで。
</code></pre>
<h2>固定ページの処理</h2>
<p>ようやくマークダウン変換でページ作れるようになりました！</p>
<p>まずは固定ページにします。固定ページは投稿日は気にしないし、一覧に入らないので、カークダウン変換とテンプレート出力だけで終わりです。</p>
<pre><code class="language-nako3">「固定ページ」を全ファイル列挙してファイルで反復
　　ファイルを開いて、情報抽出して、ページ情報に代入。
　　ファイルからファイル名抽出。
　　それから「.」まで切取ってページ名に代入。
　　HTML内容はページ情報＠「MDソース」をMDレンダー。
　　ページ情報＠「内容」はHTML内容。
　　ページ情報を、固定ページテンプレで、ページ名に出力。
ここまで。
</code></pre>
<h2>投稿の処理</h2>
<p>ここまで来て、やっと投稿の処理をします。</p>
<h3>初期化</h3>
<p>投稿は一番複雑な処理になります。あとで「タグ別」と「年別・月別」で一覧したいので、投稿ページを作りながらそういう参照テーブルにデータを挿入しておきます。ここで、参照テーブルを初期化します。</p>
<pre><code class="language-nako3">タグ参照は｛｝
投稿日参照は｛｝
全投稿は空配列。
</code></pre>
<p>投稿は全部「投稿」というフォルダに入っている、順番に「0001」、「0002」みたいなファイル名です。まず、そのファイルを列挙します。それから、メインページに最新投稿を載せたいので、その索引をしらべておきましょう。</p>
<pre><code class="language-nako3">投稿列は「投稿」の全ファイル列挙。
投稿列の要素数から１を引いて最大索引に代入。
最新投稿は投稿列＠最大索引。
</code></pre>
<h3>基本情報取得</h3>
<p>ここからは投稿ごとの処理です。少し細かいので、ちょっとずつ進んでいきます。</p>
<pre><code class="language-nako3">投稿列を投稿ファイルで反復
　　投稿ファイルを開いて、情報抽出して、投稿情報に代入。
　　投稿ファイルからファイル名抽出。
　　それから「.」まで切取って整数変換して投稿番号に代入。
</code></pre>
<p>この辺は固定ページと近い。ファイルパスからフォルダと拡張子を外して投稿番号を取得します。</p>
<p>次は、前回と次回のリンクを作るため、前と次の番号を計算します。ただ、最初投稿に前回もないし、最新投稿に次回がないので、実際にあるかどうかの確認も必要になります。そのための「ファイル検索」という関数はここで使うが、あとで定義します。最後、投稿番号が例え「１」であれば「一回目」という、漢数字変換をします。</p>
<pre><code class="language-nako3">　　投稿情報＠「投稿番号」は投稿番号。
　　投稿番号に１を足して次回番号に代入。
　　投稿情報＠「次回」は次回番号をファイル検索。
　　投稿番号から１を引いて前回番号に代入。
　　投稿情報＠「前回」は前回番号をファイル検索。
　　投稿情報＠「回目」は投稿番号の漢数字変換。
</code></pre>
<h3>タグの処理</h3>
<p>タグの処理はそんなに難しくないです。タグ参照にタグを検索します。未定義であれば、まず空配列として初期化します。それから、投稿を追加します。</p>
<pre><code class="language-nako3">　　投稿情報＠「タグ」をタグで反復
　　　　もしタグ参照＠タグ＝未定義ならば
　　　　　　タグ参照＠タグは空配列。
　　　　ここまで。
　　　　タグ参照＠タグに投稿情報を配列追加。
　　ここまで。
</code></pre>
<h3>投稿日の処理</h3>
<p>次は投稿日変換です。これは一番ややこしい処理になります。投稿日が定義されている場合、まず「−」で区切て、それから和暦に変換します。</p>
<pre><code class="language-nako3">　　もし、投稿情報＠「投稿日」≠未定義ならば、
　　　　投稿情報＠「投稿日」の「-」で区切て、要素に代入。
　　　　和暦投稿日は要素の元号変換。
</code></pre>
<p>戻ってきた値は［年、月、日］という配列になるので、それから変数に入れときます。</p>
<pre><code class="language-nako3">　　　　年は和暦投稿日＠０。
　　　　月は和暦投稿日＠１。
　　　　日は和暦投稿日＠２。
</code></pre>
<p>単純にメタデータに抽出します。</p>
<pre><code class="language-nako3">　　　　投稿情報＠「年」は年。
　　　　投稿情報＠「月」は月。
　　　　投稿情報＠「日」は日。
</code></pre>
<p>次は、投稿日参照に抽出しましょう。投稿日参照は二段階ハッシュマップという形で、年で参照をしたら、月ごとのハッシュマップを取得します。それから月で参照したら、その年のその月の投稿を前部、配列で帰っていきます。</p>
<p>タグと同じように初期化済確認をしてから抽出しますが、二段階ハッシュマップになっているため、二段階で初期化する必要があります。</p>
<pre><code class="language-nako3">　　　　もし投稿日参照＠年＝未定義ならば
　　　　　　投稿日参照＠年は｛｝。
　　　　ここまで。
　　　　もし投稿日参照[年][月]＝未定義ならば
　　　　　　投稿日参照[年][月]は空配列。
　　　　ここまで。
　　　　投稿日参照[年][月]に投稿情報を配列追加。
</code></pre>
<p>最後に、投稿日をISO形式に変換します。これはAtomフィードのためです。</p>
<pre><code class="language-nako3">　　　　投稿情報＠「投稿日」をISO変換。
　　　　投稿情報＠「投稿日ISO」はそれ。
　　ここまで。
</code></pre>
<p>もし、更新されたことがあったら、それもISO形式にして残しておきましょう。</p>
<pre><code class="language-nako3">　　もし、投稿情報＠「更新日」≠未定義ならば、
　　　　投稿情報＠「更新日」をISO変換。
　　　　投稿情報＠「更新日ISO」はそれ。
　　ここまで。
</code></pre>
<h3>投稿制作と出力</h3>
<p>ようやく必要な情報を前部集めました。マークダウン変換をして出力します。あとでフィードに出力するために、全投稿リストにも足します。</p>
<p>メインページに最新投稿を載せたいので、それだけは特別処理があります。リダレクトURLを情報に足して、ファイル名なしで出力します。</p>
<pre><code class="language-nako3">　　投稿情報＠「MDソース」をMDレンダー。
　　投稿情報＠「内容」はそれ。
　　投稿情報を、投稿テンプレで、投稿番号に出力。
　　全投稿に投稿情報を配列追加。

　　もし、投稿ファイル＝最新投稿ならば、
　　　　投稿情報＠「リダイレクト」は「/｛投稿番号｝」。
　　　　投稿情報を、投稿テンプレで、「」に出力。
　　ここまで。
ここまで。
</code></pre>
<h3>投稿原書ファイル検索</h3>
<p>前回と次回を調べるためのファイル検索関数です。投稿は前部「0001」、「0002」みたいに５桁数字のファイル名を使用ています。まず、必要な０を左に足します。</p>
<pre><code class="language-nako3">関数　（投稿番号を）ファイル検索とは
　　文字列版は投稿番号を文字列変換。
　　数は文字列版の文字数。
　　もし、数が３以下ならば、
　　　　４から数を引いて、追加分に代入。
　　　　「0」を追加分でリフレイン。
　　　　それに文字列版を追加。
　　　　文字列版はそれ。
　　ここまで。
</code></pre>
<p>それから投稿フォルダに検索します。拡張子はなんでも受け取ります。そのため、多数のファイルがある可能性がありますが、そのときは配列の最後だけを戻して、残りを処分します。</p>
<pre><code class="language-nako3">　　ファイルは「投稿/｛文字列版｝.*」のファイル列挙。
　　もし、ファイルの要素数が１以上ならば、
　　　　ファイルから配列ポップ。
　　　　それから「.」まで切取って整数変換して戻す。
　　ここまで。
ここまで。
</code></pre>
<h2>一覧表の作成</h2>
<p>投稿、固定ページ、静的ファイルが前部出力できました。あとは一覧表だけです。</p>
<h3>タグ一覧</h3>
<p>まずはタグ一覧です。タグごとに投稿一覧表を作成して、そのタグの投稿数を投稿数参照に保存しておきます。最後に、投稿数参照を参考しながら、タグの一覧表を出力します。</p>
<pre><code class="language-nako3">投稿数参照は空配列
タグ参照のハッシュキー列挙をタグで反復
　　投稿はタグ参照＠タグ。
　　タグ情報は｛
　　　　「タイトル」：タグ、
　　　　「年を表示」：はい、
　　　　「月を表示」：はい、
　　　　「投稿」：　　投稿｝
　　タグ情報を、投稿一覧で、タグに出力。
　　投稿数は投稿の要素数を漢数字変換。
　　投稿数参照に｛「タグ」：　タグ、
　　　　　　　　　「投稿数」：投稿数｝を配列追加。
ここまで。
｛「タグ」：投稿数参照｝をタグ一覧で、「タグ一覧」に出力。
</code></pre>
<h3>年別・月別一覧</h3>
<p>次は年別・月別の一覧です。タグ一覧とはやりかたがほとんど一緒ですが、年と月で二段階になっているので、二段階反復をします。</p>
<pre><code class="language-nako3">月一覧は空配列。
投稿日参照のハッシュキー列挙を年で反復
　　年参照は投稿日参照＠年。
　　月別情報は空配列。
　　年参照のハッシュキー列挙を月で反復
　　　　タイトルは［年、月］を「」で配列結合。
　　　　投稿は年参照＠月。
　　　　日付情報は｛
　　　　　　「タイトル」：タイトル、
　　　　　　「投稿」：　　投稿｝
　　　　日付情報を、投稿一覧で、「｛年｝｛月｝」に出力。
　　　　投稿数は投稿の要素数を漢数字変換。
　　　　月別情報に｛「節」：　　月、
　　　　　　　　　　「投稿」：　投稿、
　　　　　　　　　　「投稿数」：投稿数｝を配列追加。
　　ここまで。
　　日付情報は｛「タイトル」：年、「節」：月別情報｝。
　　日付情報を、投稿一覧で、年に出力。
　　月一覧に｛「年」：年、「月」：月別情報｝を配列追加。
ここまで。
全体一覧情報は｛「年」：月一覧｝。
全体一覧ファイル名は「年別・月別投稿一覧」。
全体一覧情報を全体的投稿一覧で、全体一覧ファイル名に出力。
</code></pre>
<h3>Atomフィード</h3>
<p>最後はRSS/Atomフィードの作成です。フィードリーダーで<a href="/atom.xml">このフィード</a>に購読したら、新しい投稿が出たらすぐわかります。</p>
<pre><code class="language-nako3">今日をISO変換して、本日に代入。
フィード情報は｛
　　「更新時間」：本日、
　　「投稿」：　　全投稿｝。
フィードテンプレを、フィード情報でテンプレートレンダー。
それを「出力/atom.xml」に保存。
</code></pre>
<h2>まとめ</h2>
<p>以上このサイトの作成スクリプトでした！少し長くなってしまいましたが、日本語プログラミング言語で実現的なプロジェクトができると面白いかなと思って書いてみました。</p>
<p>今回の件に対してご意見があれば是非<a href="https://twitter.com/danielpwright">@danielpwright</a>の方にツイートしてご連絡ください！そして、このブログを書く理由の一つは自分の日本語の練習のためであって、もし何か間違っている点や修正があれば、教えていただけると助かります。</p>
<p>よろしくお願いします。</p>

          <section id="footer">
              <p id="postdate">
                令和元年八月十五日
              </p>
          </section>
      </div>
    </section>
  </body>
</html>
